<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Ventas â€” Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f0f2f5;
      --text: #333;
      --header: #1a73e8;
      --table-bg: white;
      --th-bg: #f7f9fc;
      --row-hover: #f1f5fb;
      --button-bg: #1a73e8;
      --button-hover: #155ab6;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #eee;
      --header: #8ab4f8;
      --table-bg: #1e1e1e;
      --th-bg: #2c2c2c;
      --row-hover: #333;
      --button-bg: #8ab4f8;
      --button-hover: #5f9cf2;
    }

    body { font-family: 'Inter', sans-serif; margin: 20px; background: var(--bg); color: var(--text); }
    header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    h1 { font-size: 28px; color: var(--header); margin: 0; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    input, select, button { padding: 10px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
    button { background-color: var(--button-bg); color: white; border: none; cursor: pointer; transition: background 0.2s; }
    button:hover { background-color: var(--button-hover); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--table-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 12px 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: var(--th-bg); cursor: pointer; font-weight: 600; color: #555; }
    tr:hover { background: var(--row-hover); }
    .right { text-align: right; }
    #loading { color: #666; margin-top: 20px; }
    .muted { color: #777; font-size: 14px; margin-top: 8px; }
    #pager button { padding: 6px 10px; margin: 2px; border: 1px solid #ccc; border-radius: 6px; background: white; cursor: pointer; font-size: 13px; }
    #pager button:hover { background: #e0e7ff; }
    #pager strong { margin: 0 5px; font-weight: 600; }
    @media (max-width: 700px) { th, td { font-size: 12px; padding: 8px; } input, select, button { font-size: 12px; padding: 8px; } }
  </style>
</head>
<body>
  <header>
    <h1>Registro de Ventas</h1>
    <div class="controls">
      <input id="search" placeholder="Buscar por cliente, producto o id" />
      <input id="producto" placeholder="Filtrar por producto" />
      <input id="minTotal" type="number" placeholder="Total mÃ­nimo" />
      <input id="maxTotal" type="number" placeholder="Total mÃ¡ximo" />
      <input id="from" type="date" title="Fecha desde" />
      <input id="to" type="date" title="Fecha hasta" />
      <select id="perPage"><option value="10">10 por pÃ¡gina</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select>
      <button id="refresh">Actualizar</button>
      <button id="export">Exportar CSV</button>
      <button id="toggleTheme">ðŸŒ™ Modo oscuro</button>
    </div>
  </header>

  <div id="loading">Cargando datos...</div>
  <div id="summary" class="muted"></div>
  <table id="ventasTable" style="display:none">
    <thead>
      <tr>
        <th data-key="id">ID</th>
        <th data-key="fecha_hora">Fecha y hora</th>
        <th data-key="total" class="right">Total (ARS)</th>
        <th data-key="detalle_compra">Detalle</th>
        <th data-key="nombre_cliente">Cliente</th>
        <th data-key="celular_cliente">Celular</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <nav id="pager"></nav>

  <script>
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdZ1Qsrzqopm4g4s0NZJK7AKm6plFVoKvpWdymZ-MOIAktQCWsa6Ki4te4UqJUfnfK/exec';
    const url = APP_SCRIPT_URL;
    let rawData = [], filtered = [], sortKey = null, sortDir = 1, currentPage = 1;
    let lastCount = 0;

    const el = {
      loading: document.getElementById('loading'),
      table: document.getElementById('ventasTable'),
      tbody: document.querySelector('#ventasTable tbody'),
      search: document.getElementById('search'),
      producto: document.getElementById('producto'),
      minTotal: document.getElementById('minTotal'),
      maxTotal: document.getElementById('maxTotal'),
      from: document.getElementById('from'),
      to: document.getElementById('to'),
      perPage: document.getElementById('perPage'),
      refresh: document.getElementById('refresh'),
      exportBtn: document.getElementById('export'),
      pager: document.getElementById('pager'),
      summary: document.getElementById('summary'),
      toggleTheme: document.getElementById('toggleTheme')
    };

    // Restaurar tema guardado
    if(localStorage.getItem('theme')==='dark'){
      document.body.setAttribute('data-theme','dark');
      el.toggleTheme.textContent='â˜€ï¸ Modo claro';
    }

    el.toggleTheme.addEventListener('click', () => {
      if(document.body.getAttribute('data-theme')==='dark'){
        document.body.removeAttribute('data-theme');
        el.toggleTheme.textContent='ðŸŒ™ Modo oscuro';
        localStorage.setItem('theme','light');
      } else {
        document.body.setAttribute('data-theme','dark');
        el.toggleTheme.textContent='â˜€ï¸ Modo claro';
        localStorage.setItem('theme','dark');
      }
    });

    function formatDateTime(date){
      if(!date) return '';
      const d=('0'+date.getDate()).slice(-2);
      const m=('0'+(date.getMonth()+1)).slice(-2);
      const y=date.getFullYear();
      const hh=('0'+date.getHours()).slice(-2);
      const mm=('0'+date.getMinutes()).slice(-2);
      const ss=('0'+date.getSeconds()).slice(-2);
      return `${d}/${m}/${y} - ${hh}:${mm}:${ss}`;
    }

    async function fetchSheet(){
      el.loading.textContent='Cargando datos...';
      el.loading.style.display='block';
      el.table.style.display='none';
      try{
        const res=await fetch(url);
        const json=await res.json();
        const rows=json.rows||[];
        const newData=rows.map(normalizeRow);

        // NotificaciÃ³n de nuevas ventas
        if(newData.length>lastCount){
          const nuevas=newData.length-lastCount;
          if(Notification.permission==='granted'){
            new Notification('Nueva venta',{body:`Hay ${nuevas} nueva(s) venta(s)`});
          } else if(Notification.permission!=='denied'){
            Notification.requestPermission();
          }
        }
        lastCount=newData.length;
        rawData=newData;
        el.loading.style.display='none';
        el.table.style.display='';
        applyFilters();
      } catch(err){ el.loading.textContent='Error cargando la API: '+err.message; console.error(err); }
    }

    function normalizeRow(r){
      const out={}, mapKey=k=>k?k.toString().toLowerCase().replace(/\s+/g,'_'):'';
      const norm={};
      for(const k in r) norm[mapKey(k)]=r[k];
      out.id=norm.id||'';
      out.fecha_hora=norm.fecha_hora||'';
      out.total=parseNumber(norm.total||'0');
      out.detalle_compra=norm.detalle_compra||'';
      out.nombre_cliente=norm.nombre_cliente||'';
      out.celular_cliente=norm.celular_cliente||'';
      out._date=parseDateTime(out.fecha_hora);
      return out;
    }

    function parseNumber(v){ const s=v?.toString().replace(/[\$\s,]/g,'').replace(/\(.+\)/,''); const n=parseFloat(s); return isNaN(n)?0:n; }
    function parseDateTime(s){ if(!s) return null; const m=s.toString().match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/); if(!m) return new Date(s); const day=parseInt(m[1]), month=parseInt(m[2])-1, year=parseInt(m[3]); const hh=parseInt(m[4]||0), mm=parseInt(m[5]||0), ss=parseInt(m[6]||0); return new Date(year<100?2000+year:year, month, day, hh, mm, ss); }

    function renderTable(data){
      el.tbody.innerHTML='';
      const start=(currentPage-1)*parseInt(el.perPage.value,10);
      const pageData=data.slice(start,start+parseInt(el.perPage.value,10));
      for(const row of pageData){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(row.id)}</td>
          <td>${formatDateTime(row._date)}</td>
          <td class="right">${row.total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
          <td>${escapeHtml(row.detalle_compra)}</td>
          <td>${escapeHtml(row.nombre_cliente)}</td>
          <td>${escapeHtml(row.celular_cliente)}</td>
        `;
        el.tbody.appendChild(tr);
      }
      renderPager(data.length);
      el.summary.textContent=`Mostrando ${Math.min(data.length,pageData.length)} de ${data.length} ventas. Total acumulado: ARS ${sumTotals(data).toLocaleString(undefined,{minimumFractionDigits:2})}`;
    }

    function sumTotals(data){ return data.reduce((s,r)=>s+(r.total||0),0); }

    function renderPager(totalItems){
      const per=parseInt(el.perPage.value,10);
      const pages=Math.max(1,Math.ceil(totalItems/per));
      if(currentPage>pages) currentPage=pages;
      if(pages<=1){ el.pager.innerHTML=''; return; }
      let html='';
      if(currentPage>1) html+=`<button onclick="goPage(${currentPage-1})">Â«</button>`;
      for(let i=1;i<=pages;i++){ html+=i===currentPage?`<strong>${i}</strong>`:`<button onclick="goPage(${i})">${i}</button>`; }
      if(currentPage<pages) html+=`<button onclick="goPage(${currentPage+1})">Â»</button>`;
      el.pager.innerHTML=html;
    }

    window.goPage=function(p){ currentPage=p; applyFilters(); };

    function applyFilters(){
      const q=el.search.value.trim().toLowerCase();
      const prod=el.producto.value.trim().toLowerCase();
      const min=parseFloat(el.minTotal.value)||0;
      const max=parseFloat(el.maxTotal.value)||Infinity;
      const from=el.from.value?new Date(el.from.value+'T00:00:00'):null;
      const to=el.to.value?new Date(el.to.value+'T23:59:59'):null;

      filtered=rawData.filter(r=>{
        if(from && r._date && r._date<from) return false;
        if(to && r._date && r._date>to) return false;
        if(r.total<min||r.total>max) return false;
        if(prod && !r.detalle_compra.toLowerCase().includes(prod)) return false;
        if(q){ const hay=[r.id,r.detalle_compra,r.nombre_cliente,r.celular_cliente,r.fecha_hora].join(' ').toLowerCase(); if(!hay.includes(q)) return false; }
        return true;
      });

      if(sortKey){ filtered.sort((a,b)=>{ const va=a[sortKey],vb=b[sortKey]; if(va==null) return 1*sortDir; if(vb==null) return -1*sortDir; if(typeof va==='number'&&typeof vb==='number') return (va-vb)*sortDir; if(va instanceof Date && vb instanceof Date) return (va-vb)*sortDir; return va.toString().localeCompare(vb.toString())*sortDir; }); }

      renderTable(filtered);
    }

    document.querySelectorAll('#ventasTable th').forEach(th=>{ th.addEventListener('click',()=>{ const key=th.dataset.key; sortKey===key?sortDir=-sortDir:(sortKey=key,sortDir=1); applyFilters(); }); });

    function escapeHtml(s){return s==null?'':String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]));}

    [el.search,el.producto,el.minTotal,el.maxTotal,el.from,el.to].forEach(elm=>elm.addEventListener('input',()=>{currentPage=1; applyFilters();}));
    el.perPage.addEventListener('change',()=>{currentPage=1; applyFilters();});
    el.refresh.addEventListener('click',()=>fetchSheet());
    el.exportBtn.addEventListener('click',()=>exportCSV(filtered.length?filtered:rawData));

    function exportCSV(rows){
      const cols=['id','fecha_hora','total','detalle_compra','nombre_cliente','celular_cliente'];
      const lines=[cols.join(',')];
      for(const r of rows){ lines.push(cols.map(c=>`"${String(r[c]||'').replace(/"/g,'""')}"`).join(',')); }
      const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='ventas_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    fetchSheet();
    setInterval(fetchSheet,30000);
  </script>
</body>
</html>
